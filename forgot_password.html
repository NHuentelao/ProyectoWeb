<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Recuperar Contraseña - ReservaNoble</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link rel="stylesheet" href="css/inicio.css">
</head>
<body>
    <div class="page-layout" style="justify-content: center; min-height: 100vh;">
        <div class="login-box" style="max-width: 450px; margin: 20px;">
            <h2>Recuperar Contraseña</h2>
            
            <!-- PASO 1: EMAIL -->
            <div id="step-email">
                <p>Ingresa tu email para recibir un código de verificación.</p>
                <form id="emailForm">
                    <div class="input-group">
                        <i class="fas fa-envelope input-icon"></i>
                        <input type="email" id="email" name="email" placeholder="Correo electrónico" required aria-label="Correo electrónico">
                    </div>
                    <button type="submit" class="btn">Enviar Código</button>
                </form>
            </div>

            <!-- PASO 2: CÓDIGO -->
            <div id="step-code" style="display: none;">
                <p>Hemos enviado un código a tu correo. Ingrésalo aquí:</p>
                <form id="codeForm">
                    <div class="input-group">
                        <i class="fas fa-key input-icon"></i>
                        <input type="text" id="code" name="code" placeholder="Código de 6 dígitos" maxlength="6" required autocomplete="off">
                    </div>
                    <button type="submit" class="btn">Verificar Código</button>
                </form>
            </div>

            <!-- PASO 3: NUEVA CONTRASEÑA -->
            <div id="step-password" style="display: none;">
                <p>Ingresa tu nueva contraseña.</p>
                <form id="passwordForm">
                    <div class="input-group">
                        <i class="fas fa-lock input-icon"></i>
                        <input type="password" id="newPassword" name="newPassword" placeholder="Nueva contraseña" required minlength="6">
                    </div>
                    <div class="input-group">
                        <i class="fas fa-lock input-icon"></i>
                        <input type="password" id="confirmPassword" placeholder="Confirmar contraseña" required minlength="6">
                    </div>
                    <button type="submit" class="btn">Cambiar Contraseña</button>
                </form>
            </div>

            <p class="msg" id="msg"></p>
            <p><a href="index.html">Volver al Inicio</a></p>
        </div>
    </div>

    <script>
        const msgEl = document.getElementById('msg');
        
        function showMsg(text, type) {
            if(msgEl) {
                msgEl.textContent = text;
                msgEl.className = 'msg ' + type;
            }
        }

        // PASO 1: Enviar Email
        document.getElementById('emailForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            const email = document.getElementById('email').value.trim();
            if (!email) return;

            const btn = e.target.querySelector('.btn');
            const originalText = btn.textContent;
            btn.disabled = true;
            btn.textContent = 'Enviando...';
            showMsg('', '');

            try {
                const response = await fetch('api/api.php?action=forgot_password', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ email })
                });
                
                // Manejo robusto de la respuesta
                const text = await response.text();
                let data;
                try {
                    data = JSON.parse(text);
                } catch (err) {
                    console.error('Error parsing JSON:', text);
                    throw new Error('Respuesta inválida del servidor');
                }
                
                if (data.success) {
                    showMsg(data.message, 'success');
                    // Ocultar paso 1 y mostrar paso 2
                    document.getElementById('step-email').style.display = 'none';
                    document.getElementById('step-code').style.display = 'block';
                    // Enfocar el input del código
                    setTimeout(() => document.getElementById('code').focus(), 100);
                } else {
                    showMsg(data.message, 'error');
                }
            } catch (error) {
                console.error(error);
                showMsg('Error de conexión o servidor.', 'error');
            }
            btn.disabled = false;
            btn.textContent = originalText;
        });

        // PASO 2: Verificar Código
        document.getElementById('codeForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            const code = document.getElementById('code').value.trim();
            if (!code) return;

            const btn = e.target.querySelector('.btn');
            const originalText = btn.textContent;
            btn.disabled = true;
            btn.textContent = 'Verificando...';
            showMsg('', '');

            try {
                const response = await fetch('api/api.php?action=verify_reset_code', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ code })
                });
                
                const text = await response.text();
                let data;
                try {
                    data = JSON.parse(text);
                } catch (err) {
                    console.error('Error parsing JSON:', text);
                    throw new Error('Respuesta inválida del servidor');
                }
                
                if (data.success) {
                    showMsg(data.message, 'success');
                    document.getElementById('step-code').style.display = 'none';
                    document.getElementById('step-password').style.display = 'block';
                    setTimeout(() => document.getElementById('newPassword').focus(), 100);
                } else {
                    showMsg(data.message, 'error');
                }
            } catch (error) {
                console.error(error);
                showMsg('Error de conexión.', 'error');
            }
            btn.disabled = false;
            btn.textContent = originalText;
        });

        // PASO 3: Cambiar Contraseña
        document.getElementById('passwordForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            const p1 = document.getElementById('newPassword').value;
            const p2 = document.getElementById('confirmPassword').value;

            if (p1 !== p2) {
                showMsg('Las contraseñas no coinciden.', 'error');
                return;
            }
            if (p1.length < 6) {
                showMsg('La contraseña debe tener al menos 6 caracteres.', 'error');
                return;
            }

            const btn = e.target.querySelector('.btn');
            const originalText = btn.textContent;
            btn.disabled = true;
            btn.textContent = 'Guardando...';
            showMsg('', '');

            try {
                const response = await fetch('api/api.php?action=reset_password_final', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ password: p1 })
                });
                
                const text = await response.text();
                let data;
                try {
                    data = JSON.parse(text);
                } catch (err) {
                    console.error('Error parsing JSON:', text);
                    throw new Error('Respuesta inválida del servidor');
                }
                
                if (data.success) {
                    showMsg(data.message, 'success');
                    setTimeout(() => {
                        window.location.href = 'index.html#login';
                    }, 2000);
                } else {
                    showMsg(data.message, 'error');
                }
            } catch (error) {
                console.error(error);
                showMsg('Error de conexión.', 'error');
            }
            btn.disabled = false;
            btn.textContent = originalText;
        });
    </script>
</body>
</html>