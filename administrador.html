<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Panel de Administraci√≥n - Reserva Eventos</title>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
  <link rel="stylesheet" href="css/administrador.css">
  <script>
    // Check session status and role
    let APP_ADMIN_USER = null;
    fetch('api/api.php?action=get_current_user_full')
      .then(response => {
        if (response.ok) {
          return response.json();
        }
        throw new Error('Not logged in');
      })
      .then(user => {
        if (user.rol !== 'admin') {
          window.location.href = 'formulario.html';
        } else {
          APP_ADMIN_USER = user;
          document.body.classList.remove('hidden-body');
          // Trigger any initialization that depends on APP_ADMIN_USER if needed
        }
      })
      .catch(() => {
        window.location.href = 'index.html';
      });
  </script>
  <style>
    .hidden-body { display: none; }
  </style>
</head>
<body class="hidden-body">

  <div class="sidebar">
    <h2>üéõÔ∏è Menu</h2>
    <div class="sidebar-links">
      <a href="#reservas" class="active" data-section="reservas"><i class="fas fa-inbox"></i> <span>Reservas</span></a>
      <a href="#usuarios" data-section="usuarios"><i class="fas fa-users"></i> <span>Usuarios</span></a>
      <a href="#lugares" data-section="lugares"><i class="fas fa-map-marked-alt"></i> <span>Lugares</span></a>
      <a href="#reportes" data-section="reportes"><i class="fas fa-flag"></i> <span>Reportes</span></a>
      <a href="#mensajes" data-section="mensajes"><i class="fas fa-envelope"></i> <span>Mensajes</span></a>
    </div>
    <button class="logout-btn" id="adminLogout"><i class="fas fa-sign-out-alt"></i> <span>Cerrar sesi√≥n</span></button>
  </div>

  <div class="main-content">
    <header>
      <div>
        <h1>Panel de Administrador</h1>
        <p class="texto-claro">Gestiona solicitudes, usuarios, lugares y reportes</p>
      </div>
    </header>

    <div id="reservas" class="section">
      <div class="section-header" style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
        <div class="section-title" style="margin-bottom: 0;">Solicitudes</div>
        
        <!-- Buscador de Reservas -->
        <div class="search-box" style="display: flex; gap: 10px;">
            <input type="text" id="searchReservationInput" placeholder="Buscar por correo o nombre..." 
                   style="padding: 8px 12px; border-radius: 6px; border: 1px solid #cbd5e1; width: 300px; background: rgba(255,255,255,0.1); color: white;">
            <button onclick="filterReservations()" class="btn primary small"><i class="fas fa-search"></i></button>
        </div>
      </div>

      <!-- Pesta√±as de Navegaci√≥n -->
      <div class="tabs-container" style="margin-bottom: 20px; border-bottom: 1px solid rgba(255,255,255,0.1); display: flex; gap: 10px;">
          <button class="tab-btn active" onclick="switchReservationTab('pending')">
              <i class="fas fa-clock"></i> Pendientes <span id="countPending" class="badge-count">0</span>
          </button>
          <button class="tab-btn" onclick="switchReservationTab('active')">
              <i class="fas fa-check-circle"></i> Aprobadas
          </button>
          <button class="tab-btn" onclick="switchReservationTab('rejected')">
              <i class="fas fa-times-circle"></i> Rechazadas
          </button>
          <button class="tab-btn" onclick="switchReservationTab('history')">
              <i class="fas fa-history"></i> Historial Pasado
          </button>
      </div>

      <div id="requestsContainer">
        <table id="requestsTable">
          <thead>
            <tr>
              <th>Nombre</th><th>Email</th><th>Tel</th><th>Evento</th><th>Fecha</th><th>Duraci√≥n</th><th>Hora</th><th>Lugar</th>
              <th>Invitados</th><th>Precio Total</th><th>Estado</th><th>Acciones</th>
            </tr>
          </thead>
          <tbody id="reservationsTableBody"></tbody>
        </table>
      </div>
    </div>

    <div id="usuarios" class="section">
      <div class="section-title">Usuarios</div>
      <div class="table-responsive">
        <table id="usersTable">
          <thead><tr><th>Nombre</th><th>Email</th><th>Tel</th><th>Rol</th><th>Creado</th><th>Acciones</th></tr></thead>
          <tbody></tbody>
        </table>
      </div>
    </div>

    <div id="lugares" class="section">
      <div class="section-title">
          Lugares
          <button onclick="openVenueModal()" class="btn" style="background: var(--primary-color);">
              <i class="fas fa-plus"></i> Nuevo Lugar
          </button>
      </div>
      
      <div class="venues-title" style="margin-top: 0; border-top: none;"><h3>Lista de Lugares</h3></div>
      <div class="table-responsive">
        <table id="venuesTable">
          <thead>
            <tr>
              <th>Nombre</th>
              <th>Direcci√≥n</th>
              <th>Capacidad</th>
              <th>Precio Base</th><th>Precio p/P</th><th>Estado</th>
              <th>Acciones</th>
            </tr>
          </thead>
          <tbody></tbody>
        </table>
      </div>
    </div>

    <!-- Modal de Gesti√≥n de Lugar (Crear/Editar) -->
    <div id="venueModal" class="modal hidden">
        <div class="modal-content" style="width: 1100px; max-width: 95vw; max-height: 90vh; overflow-y: auto;">
            <div class="modal-header">
                <h3 id="venueModalTitle"><i class="fas fa-building"></i> Gestionar Lugar</h3>
                <button onclick="document.getElementById('venueModal').classList.add('hidden')" class="close-btn">&times;</button>
            </div>
            
            <div class="eventos-container" style="margin: 0; gap: 20px;">
                <div class="eventos-form" style="flex: 1; max-width: none;">
                  <form id="venueForm" class="venue-form">
                    <div class="form-group">
                      <label for="venue-name">Nombre</label>
                      <input type="text" id="venue-name" required>
                    </div>
                    <div class="form-group">
                      <label for="venue-address">Direcci√≥n</label>
                      <input type="text" id="venue-address" required>
                    </div>
                    
                    <div class="form-group">
                      <label for="venue-description">Descripci√≥n Detallada</label>
                      <textarea id="venue-description" rows="3" placeholder="Describe el lugar..."></textarea>
                    </div>
        
                    <!-- Datos del Due√±o (Privado) -->
                    <div class="owner-section" style="padding: 15px; border-radius: 8px; margin-bottom: 15px;">
                        <h4 style="margin-top: 0; margin-bottom: 10px; color: #475569; font-size: 0.95rem;">
                            <i class="fas fa-user-shield"></i> Datos del Locatario (Privado)
                        </h4>
                        <div class="form-row">
                            <div class="form-group">
                                <label for="owner-name">Nombre del Due√±o</label>
                                <input type="text" id="owner-name" placeholder="Nombre completo">
                            </div>
                            <div class="form-group">
                                <label for="owner-phone">Tel√©fono</label>
                                <div class="phone-input" style="display: flex; align-items: center; border: 1px solid rgba(255,255,255,0.1); border-radius: 8px; overflow: hidden; background: rgba(255,255,255,0.05);">
                                    <span class="prefix" style="padding: 12px; color: #cbd5e1; font-weight: 500; border-right: 1px solid rgba(255,255,255,0.1); user-select: none;">+56 9</span>
                                    <input type="tel" id="owner-phone" placeholder="12345678" maxlength="8" pattern="[0-9]{8}" oninput="this.value = this.value.replace(/[^0-9]/g, '').slice(0, 8);" style="border: none; border-radius: 0; flex: 1; background: transparent; color: white;">
                                </div>
                            </div>
                        </div>
                        <div class="form-group">
                            <label for="owner-email">Correo Electr√≥nico</label>
                            <input type="email" id="owner-email" placeholder="contacto@due√±o.com">
                        </div>
                    </div>
        
                    <div class="form-group">
                      <label for="venue-services">Servicios (separados por coma)</label>
                      <input type="text" id="venue-services" placeholder="Wifi, Estacionamiento, Ba√±os, Seguridad...">
                      <small style="color: #666; display: block; margin-top: 5px;">
                          Iconos autom√°ticos para: <b>Wifi, Estacionamiento, Ba√±os, Cocina, Aire Acondicionado, Seguridad, Accesibilidad</b>. 
                          <br>Cualquier otro texto se mostrar√° con un icono gen√©rico.
                      </small>
                    </div>
        
                    <div class="form-group">
                      <label>Imagen del Lugar</label>
                      
                      <!-- Opci√≥n 1: Subir Archivo -->
                      <div style="margin-bottom: 15px; background: rgba(255,255,255,0.05); padding: 10px; border-radius: 8px; border: 1px dashed #cbd5e1;">
                          <label for="venue-image-file" style="font-size: 0.9rem; color: #333; display: block; margin-bottom: 5px; font-weight: 600;">
                              <i class="fas fa-cloud-upload-alt"></i> Subir im√°genes (Recomendado)
                          </label>
                          <input type="file" id="venue-image-file" accept="image/*" multiple style="width: 100%;">
                          <small style="color: #666; display: block; margin-top: 4px;">Puedes seleccionar varias im√°genes. Se guardar√°n en la base de datos.</small>
                      </div>

                      <!-- Contenedor para vista previa -->
                      <div id="gallery-preview-container" style="margin-top: 10px; display: none;">
                          <p style="font-size: 0.8rem; color: #666; margin-bottom: 5px;">Vista previa:</p>
                          <div id="gallery-preview" style="display: flex; gap: 10px; flex-wrap: wrap;"></div>
                      </div>
                    </div>
        
                    <div class="form-row">
                      <div class="form-group">
                        <label for="venue-capacity">Capacidad M√°xima</label>
                        <input type="number" id="venue-capacity" placeholder="Ej: 100">
                      </div>
                      <div class="form-group">
                        <label for="venue-base-price">Precio Base (Fijo)</label>
                        <input type="number" id="venue-base-price" placeholder="Ej: 500">
                      </div>
                    </div>
                    <div class="form-group"> <label for="venue-price-per-guest">Precio por Persona</label>
                      <input type="number" id="venue-price-per-guest" placeholder="Ej: 10">
                    </div>
                    <div class="form-row">
                      <div class="form-group">
                        <label for="venue-lat">Latitud</label>
                        <input type="text" id="venue-lat" readonly required>
                      </div>
                      <div class="form-group">
                        <label for="venue-lng">Longitud</label>
                        <input type="text" id="venue-lng" readonly required>
                      </div>
                    </div>
                    <div class="form-actions">
                      <button type="submit" class="btn">Guardar Lugar</button>
                      <button type="button" onclick="document.getElementById('venueModal').classList.add('hidden')" class="btn secondary">Cancelar</button>
                    </div>
                    <div id="venueMsg" class="msg"></div>
                  </form>
                </div>
                <div class="eventos-map" style="flex: 1; min-height: 400px;">
                  <div id="adminMap" style="height: 100%; min-height: 400px; border-radius: 8px;"></div>
                  <p style="font-size: 0.85rem; color: #666; margin-top: 10px; text-align: center;">
                      <i class="fas fa-info-circle"></i> Haz clic en el mapa para establecer la ubicaci√≥n.
                  </p>
                </div>
            </div>
        </div>
    </div>

    <div id="reportes" class="section">
      <div class="section-title">Reportes</div>
      
      <!-- Pesta√±as Reportes -->
      <div class="tabs-container" style="margin-bottom: 20px; border-bottom: 1px solid rgba(255,255,255,0.1); display: flex; gap: 10px;">
          <button class="tab-btn active" onclick="switchReportTab('pending')">
              <i class="fas fa-clock"></i> Pendientes <span id="countReportsPending" class="badge-count">0</span>
          </button>
          <button class="tab-btn" onclick="switchReportTab('resolved')">
              <i class="fas fa-check-circle"></i> Resueltos
          </button>
      </div>

      <div class="table-responsive">
        <table id="reportsTable">
          <thead>
            <tr>
              <th>Nombre</th>
              <th>Email</th>
              <th>Tipo</th>
              <th>Mensaje</th>
              <th>Acciones</th>
            </tr>
          </thead>
          <tbody id="reportsTableBody"></tbody>
        </table>
      </div>
    </div>

    <div id="mensajes" class="section">
      <div class="section-title">Mensajes de Contacto</div>

      <!-- Pesta√±as Mensajes -->
      <div class="tabs-container" style="margin-bottom: 20px; border-bottom: 1px solid rgba(255,255,255,0.1); display: flex; gap: 10px;">
          <button class="tab-btn active" onclick="switchMessageTab('unread')">
              <i class="fas fa-envelope"></i> No Le√≠dos <span id="countMessagesUnread" class="badge-count">0</span>
          </button>
          <button class="tab-btn" onclick="switchMessageTab('read')">
              <i class="fas fa-envelope-open"></i> Le√≠dos
          </button>
      </div>

      <div class="table-responsive">
        <table id="messagesTable">
          <thead>
            <tr>
              <th>Fecha</th>
              <th>Nombre</th>
              <th>Email</th>
              <th>Asunto</th>
              <th>Mensaje</th>
              <th>Acciones</th>
            </tr>
          </thead>
          <tbody id="messagesTableBody"></tbody>
        </table>
      </div>
    </div>
  </div> 
  
  <div id="editUserModal" class="modal hidden">
    <div class="modal-content">
      <div class="modal-header">
        <h3><i class="fas fa-user-edit"></i> Editar Usuario</h3>
        <button id="closeEditUserBtn" class="close-btn">&times;</button>
      </div>
      <form id="editUserForm" class="venue-form" novalidate>
        <div class="form-group">
          <label for="editUserName">Nombre completo</label>
          <input type="text" id="editUserName" required>
        </div>
        <div class="form-group">
          <label for="editUserEmail">Correo electr√≥nico</label>
          <input type="email" id="editUserEmail" required>
        </div>
        <div class="form-group">
            <label for="editUserPhone">Tel√©fono</label>
            <div class="phone-input" style="display: flex; align-items: center; border: 1px solid #cbd5e1; border-radius: 8px; overflow: hidden; background: #f8fafc;">
                <span class="prefix" style="padding: 12px; color: #64748b; font-weight: 500; border-right: 1px solid #cbd5e1; background: #f1f5f9; user-select: none;">+56 9</span>
                <input type="tel" id="editUserPhone" placeholder="12345678" required maxlength="8" pattern="[0-9]{8}" oninput="this.value = this.value.replace(/[^0-9]/g, '').slice(0, 8);" style="border: none; border-radius: 0; flex: 1; background: transparent; color: #0f172a; height: 100%;">
            </div>
        </div>
        <div class="form-group">
          <label for="editUserPassword">Nueva Contrase√±a (dejar en blanco para no cambiar)</label>
          <input type="password" id="editUserPassword" placeholder="Nueva contrase√±a">
        </div>
        <div class="form-group">
          <label for="editUserRole">Rol</label>
          <select id="editUserRole" required>
              <option value="user">Usuario (user)</option>
              <option value="admin">Administrador (admin)</option>
          </select>
        </div>
        <div class="form-actions" style="justify-content: flex-end;">
            <button type="submit" class="btn">Guardar Cambios</button>
            <button type="button" id="cancelEditUserBtn" class="btn secondary">Cancelar</button>
        </div>
        <div id="editUserMsg" class="msg" style="margin-top: 12px;"></div>
      </form>
    </div>
  </div>

  <!-- Modal de Enviar Correo Directo -->
  <div id="emailUserModal" class="modal hidden">
    <div class="modal-content">
      <div class="modal-header">
        <h3><i class="fas fa-envelope"></i> Enviar Correo a Usuario</h3>
        <button id="closeEmailUserBtn" class="close-btn">&times;</button>
      </div>
      <form id="emailUserForm" class="venue-form">
        <input type="hidden" id="emailUserEmail">
        <div class="form-group">
          <label>Para:</label>
          <input type="text" id="emailUserTo" readonly disabled style="background: #f3f4f6;">
        </div>
        <div class="form-group">
          <label for="emailUserSubject">Asunto</label>
          <input type="text" id="emailUserSubject" required>
        </div>
        <div class="form-group">
          <label for="emailUserMessage">Mensaje</label>
          <textarea id="emailUserMessage" rows="5" required></textarea>
        </div>
        <div class="form-actions">
          <button type="submit" class="btn">Enviar Correo</button>
          <button type="button" id="cancelEmailUserBtn" class="btn secondary">Cancelar</button>
        </div>
      </form>
    </div>
  </div>

  <!-- Modal de Cambio de Estado de Lugar -->
  <div id="venueStatusModal" class="modal hidden">
    <div class="modal-content" style="max-width: 400px; text-align: center;">
      <div class="modal-header" style="justify-content: center; border: none;">
        <h3>Cambiar Estado del Lugar</h3>
      </div>
      <p id="venueStatusName" style="margin-bottom: 20px; color: #666;"></p>
      <input type="hidden" id="venueStatusIndex">
      
      <div class="status-options" style="display: flex; flex-direction: column; gap: 10px;">
        <button onclick="setVenueStatus('available')" class="btn" style="background: #10b981; width: 100%;">
          <i class="fas fa-check-circle"></i> Disponible
        </button>
        <button onclick="setVenueStatus('maintenance')" class="btn" style="background: #f59e0b; width: 100%;">
          <i class="fas fa-tools"></i> Mantenimiento
        </button>
        <button onclick="setVenueStatus('reserved')" class="btn" style="background: #ef4444; width: 100%;">
          <i class="fas fa-lock"></i> Reservado
        </button>
      </div>
      
      <div class="form-actions" style="justify-content: center; margin-top: 20px;">
        <button onclick="document.getElementById('venueStatusModal').classList.add('hidden')" class="btn secondary">Cancelar</button>
      </div>
    </div>
  </div>

  <!-- Modal de Informaci√≥n del Due√±o -->
  <div id="ownerInfoModal" class="modal hidden">
    <div class="modal-content" style="max-width: 400px;">
      <div class="modal-header">
        <h3><i class="fas fa-user-tie"></i> Datos del Locatario</h3>
        <button onclick="document.getElementById('ownerInfoModal').classList.add('hidden')" class="close-btn">&times;</button>
      </div>
      <div id="ownerInfoContent" style="padding: 10px 0;">
        <!-- Se llena din√°micamente -->
      </div>
      <div class="form-actions" style="justify-content: flex-end;">
        <button onclick="document.getElementById('ownerInfoModal').classList.add('hidden')" class="btn secondary">Cerrar</button>
      </div>
    </div>
  </div>

  <!-- Modal de Respuesta a Mensajes -->
  <div id="replyMessageModal" class="modal hidden">
    <div class="modal-content">
      <div class="modal-header">
        <h3><i class="fas fa-reply"></i> Responder Mensaje</h3>
        <button id="closeReplyModalBtn" class="close-btn">&times;</button>
      </div>
      <form id="replyMessageForm" class="venue-form">
        <input type="hidden" id="replyMessageId">
        <input type="hidden" id="replyMessageType">
        <input type="hidden" id="replyMessageEmail">
        <div class="form-group">
          <label for="replyMessageSubject">Asunto</label>
          <input type="text" id="replyMessageSubject" required>
        </div>
        <div class="form-group">
          <label for="replyMessageBody">Respuesta</label>
          <textarea id="replyMessageBody" rows="5" required></textarea>
        </div>
        <div class="form-actions">
          <button type="submit" class="btn">Enviar Respuesta</button>
          <button type="button" id="cancelReplyModalBtn" class="btn secondary">Cancelar</button>
        </div>
      </form>
    </div>
  </div>

  <!-- Modal de Confirmaci√≥n Gen√©rico -->
  <div id="confirmModal" class="modal hidden">
    <div class="modal-content">
      <div class="modal-header" style="border:none; padding-bottom:0;">
        <h3 style="width:100%; justify-content:center;"><i class="fas fa-exclamation-triangle"></i> Confirmar Acci√≥n</h3>
      </div>
      <p id="confirmMessage">¬øEst√°s seguro de realizar esta acci√≥n?</p>
      <div class="form-actions" style="justify-content:center;">
        <button id="confirmBtn" class="btn" style="background: var(--danger-color);">S√≠, confirmar</button>
        <button id="cancelConfirmBtn" class="btn secondary">Cancelar</button>
      </div>
    </div>
  </div>

  <!-- Modal para Ver Mensaje Completo -->
  <div id="viewMessageModal" class="modal hidden">
    <div class="modal-content" style="max-width: 600px;">
      <div class="modal-header">
        <h3><i class="fas fa-comment-alt"></i> Detalle del Mensaje</h3>
        <button onclick="document.getElementById('viewMessageModal').classList.add('hidden')" class="close-btn">&times;</button>
      </div>
      <div id="viewMessageContent" style="padding: 20px; background: #f9fafb; border-radius: 8px; border: 1px solid #e5e7eb; margin-bottom: 20px; white-space: pre-wrap; max-height: 400px; overflow-y: auto; font-size: 1rem; line-height: 1.5; color: #374151;">
        <!-- Contenido del mensaje -->
      </div>
      <div class="form-actions" style="justify-content: flex-end;">
        <button onclick="document.getElementById('viewMessageModal').classList.add('hidden')" class="btn secondary">Cerrar</button>
      </div>
    </div>
  </div>

  <!-- Lightbox para im√°genes -->
  <div id="lightboxModal" class="modal hidden" style="z-index: 10000; background: rgba(0,0,0,0.9);">
      <span class="close-btn" onclick="document.getElementById('lightboxModal').classList.add('hidden')" style="position: absolute; top: 20px; right: 30px; color: white; font-size: 40px; cursor: pointer;">&times;</span>
      <div style="display: flex; justify-content: center; align-items: center; height: 100%; width: 100%;">
          <img id="lightboxImage" src="" style="max-width: 90%; max-height: 90%; object-fit: contain; border-radius: 4px; box-shadow: 0 0 20px rgba(0,0,0,0.5);">
      </div>
  </div>

  <!-- Contenedor de Toasts -->
  <div id="toast-container"></div>

  <script src="js/toast.js"></script>
  <script src="js/administrador.js"></script>
  <script src="https://maps.googleapis.com/maps/api/js?key=AIzaSyC59R63rSWzCG9hIV3chuKsprNPZSODL1U&libraries=places&callback=initAdminMap" async defer></script>
  
  <script>
    // Navegaci√≥n (sin cambios)
    (function(){
      const links = document.querySelectorAll('.sidebar a');
      const sections = document.querySelectorAll('.section');
      function show(id){
        sections.forEach(s=> s.id === id ? s.classList.add('active') : s.classList.remove('active'));
        links.forEach(a=> a.classList.toggle('active', a.dataset.section === id));
      }
      links.forEach(a=> a.addEventListener('click', e=> { e.preventDefault(); show(a.dataset.section); }));
      
      let initialSection = window.location.hash.substring(1);
      if (!['reservas', 'usuarios', 'lugares', 'reportes', 'mensajes'].includes(initialSection)) {
          initialSection = 'reservas';
      }
      show(initialSection);
      
      links.forEach(a => a.addEventListener('click', e => {
          e.preventDefault();
          const section = a.dataset.section;
          show(section);
          window.location.hash = section;
      }));

      // LOGOUT (ACTUALIZADO A FETCH)
      const out = document.getElementById('adminLogout');
      if(out) out.addEventListener('click', async ()=> { 
        // Llama a la API en la carpeta 'api'
        await fetch('api/api.php?action=logout', { method: 'POST' });
        window.location.href='index.html'; 
      });
    })();

    // Carga inicial de datos
    document.addEventListener('DOMContentLoaded', ()=>{ 
        // Wait for APP_ADMIN_USER to be set by the head script
        const checkUser = setInterval(() => {
            if (typeof APP_ADMIN_USER !== 'undefined' && APP_ADMIN_USER !== null) {
                clearInterval(checkUser);
                if(window.adminRefreshAll) {
                    window.adminRefreshAll(); 
                }
            }
        }, 100);
    });
  </script>
</body>
</html>